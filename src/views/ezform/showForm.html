<br>
<div class="panel panel-primary">
    <div class="panel-heading"></div>
    <div class="panel-body">
        <table class="kv-grid-table table table-hover table-bordered table-striped table-condensed">
            <thead>

                <tr class="kartik-sheet-style">
                    <th>ชื่อเป้าหมาย</th>
                    <th>ลักษณะหลัก</th>
                    <th>หน่วยงาน</th>
                    <th><a href="">วันที่แก้ไขล่าสุด</a></th>
                    <th>Action</th>
                </tr>

            </thead>
            <tbody id="tbody">

            </tbody>
        </table>
    </div>
</div>
<button type="button" id="addNewRecord" class="btn btn-lg btn-success" data-toggle="tooltip" data-original-title="เพิ่มข้อมูลใหม่"><i class="glyphicon glyphicon-plus"></i> เพิ่มข้อมูลใหม่ใน Ezform Framework Version1</button>้
<hr style="border: 1px solid #333;">

<div class="ezform-record" style="display:none">
    <div class="">
        <div class="panel panel-primary">
            <div class="panel-heading" style="padding: 10px;">
                <h5 class="box-title" style="font-size: 18px;"><i class="fa fa-pencil-square-o"></i> แก้ไขข้อมูลเดิม</h5>
            </div>
            <div class="panel-body">
                <h1 id="panelTitle"></h1>
                <hr style="border: 2px solid #333;">
                <div>
                    <input type="text" class="form-control" id="updateID">
                    <input type="text" class="form-control" id="updateTABLE">
                </div>
                <div id="Index2Ezform"></div>
                <div id="Index2Ezbutton"></div>
            </div>
        </div>
    </div>
</div>

<script>
    let knexRemote = require('./assets/js/sql/knex-sqlite3.js');
    $("#addNewRecord").click(function () {
        let id = myID();
        let data = {};
        data['id'] = id;
        GetEzformSearch(ezf_id).then((row) => {//
            knexRemote.knexInsertColumToLocal(row[0].ezf_table, data)
                .then((res) => {
                    $("#updateID").val(id);
                    $("#updateTABLE").val(row[0].ezf_table);
                    LoadForm(ezf_id);
                });
        });

    });

    //GetEzformSearch(ezf_id);
    async function GetEzformSearch(ezf_id, table = "") {
        if (table == "") {
            table = "ezform_search";
        }
        return await knexRemote.knexfindById2(table, { ezf_id: ezf_id });
        // data.then(res=>{
        //     LoadForm(res[0].ezf_table);
        // });
    }
    LoadForm(ezf_id);
    function LoadForm(ezf_id = '') {
        $("#tbody").html('');
        GetEzformSearch(ezf_id)
            .then((res) => {
                knexRemote.knexfindAll(res[0].ezf_table).subscribe((response) => {
                    // console.log(response);
                    let tbody = `
                    <tr>
                        <td>ไม่มีเป้าหมาย</td>
                        <td>-</td>
                        <td>-</td>
                        <td>-</td>
                        <td> <button onclick='UpdateForm("${ezf_id}","${res[0].ezf_table}","${response.id}")' class='open-form btn btn-primary'><i class='fa fa-edit'></i>  ดู / แก้ไข</button>
                        </td>    
                    </tr>    
                `;
                    $("#tbody").append(tbody);
                });
            });

    }
    $("#addNewRecord").click(function () {

        record_ezform();
    });
    function record_ezform() {
        Index2LoadTemplateEzform(ezf_id);
        $(".ezform-record").show();

    }
    function UpdateForm(ezf_id, table, id) {
        $("#updateID").val(id);
        $("#updateTABLE").val(table);
        record_ezform();
        //console.log("OK " + table);
        knexRemote.knexfindById(table, { id: id }).subscribe(
            (row) => {

                knexRemote.knexfindById("ezform_fields", { ezf_id: ezf_id }).subscribe((res) => {
                    var arr = [];
                        for (var key in row) {
                            if (row.hasOwnProperty(key)) {
                                arr[key] = row[key]
                            }
                        };
                    if (res.ezf_field_type == 1) {
                        $("#sddynamicmodel-"+res.ezf_field_name).val(arr[res.ezf_field_name]); 
                    }
                    if(res.ezf_field_type == 23){
                        var radios = $("#sddynamicmodel-"+res.ezf_field_name);
                        console.log(radios);
                            if(radios.is(':checked') === false) {
                                radios.filter('[value='+arr[res.ezf_field_name]+']').prop('checked', true);
                        }
                    }
                })

            },
            (err) => { console.log(err) }
        );


    }
    function myID() {
        var n = Date.now();
        let val = n * 1000;
        return n + giveValues();
    }
    function giveValues() {
        var number = Math.round((Math.random() * 999999999));
        return number.toString().substr(0, 4);
    }

</script>