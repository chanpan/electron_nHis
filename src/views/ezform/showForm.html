<br>
<div class="panel panel-primary">
    <div class="panel-heading"></div>
    <div class="panel-body">
        <table class="kv-grid-table table table-hover table-bordered table-striped table-condensed">
            <thead>

                <tr class="kartik-sheet-style">
                    <th>ชื่อเป้าหมาย</th>
                    <th>ลักษณะหลัก</th>
                    <th>หน่วยงาน</th>
                    <th><a href="">วันที่แก้ไขล่าสุด</a></th>
                    <th>Action</th>
                </tr>

            </thead>
            <tbody id="tbody">

            </tbody>
        </table>
    </div>
</div>
<button type="button" id="addNewRecord" class="btn btn-lg btn-success" data-toggle="tooltip" data-original-title="เพิ่มข้อมูลใหม่"><i class="glyphicon glyphicon-plus"></i> เพิ่มข้อมูลใหม่ใน Ezform Framework Version1</button>้
<hr style="border: 1px solid #333;">

<div class="ezform-record" style="display:none">
    <div class="">
        <div class="panel panel-primary">
            <div class="panel-heading" style="padding: 10px;">
                <h5 class="box-title" style="font-size: 18px;"><i class="fa fa-pencil-square-o"></i> แก้ไขข้อมูลเดิม</h5>
            </div>
            <div class="panel-body">
                <h1 id="panelTitle"></h1>
                <hr style="border: 2px solid #333;">
                <div>
                    <input type="text" class="form-control" id="updateID">
                    <input type="text" class="form-control" id="updateTABLE">
                </div>
                <div id="Index2Ezform"></div>
                <div id="Index2Ezbutton"></div>
            </div>
        </div>
    </div>
</div>





<script>
    let knexRemote = require('./assets/js/sql/knex-sqlite3.js');
    $("#addNewRecord").click(function () {
        let id = myID();
        let data = {};
        data['id'] = id;
        GetEzformSearch(ezf_id).then((row) => {//
            knexRemote.knexInsertColumToLocal(row[0].ezf_table, data)
                .then((res) => {
                    $("#updateID").val(id);
                    $("#updateTABLE").val(row[0].ezf_table);
                    LoadForm(ezf_id);
                });
        });

    });

    //GetEzformSearch(ezf_id);
    async function GetEzformSearch(ezf_id, table = "") {
        if (table == "") {
            table = "ezform_search";
        }
        return await knexRemote.knexfindById2(table, { ezf_id: ezf_id });
        // data.then(res=>{
        //     LoadForm(res[0].ezf_table);
        // });
    }
    LoadForm(ezf_id);
    function LoadForm(ezf_id = '') {
        $("#tbody").html('');
        GetEzformSearch(ezf_id)
            .then((res) => {
                knexRemote.knexfindAll(res[0].ezf_table).subscribe((response) => {
                    // console.log(response);
                    let tbody = `
                    <tr>
                        <td>ไม่มีเป้าหมาย</td>
                        <td>-</td>
                        <td>-</td>
                        <td>-</td>
                        <td> <button onclick='UpdateForm("${ezf_id}","${res[0].ezf_table}","${response.id}")' class='open-form btn btn-primary'><i class='fa fa-edit'></i>  ดู / แก้ไข</button>
                        </td>    
                    </tr>    
                `;
                    $("#tbody").append(tbody);
                });
            });

    }
    $("#addNewRecord").click(function () {

        record_ezform();
    });
    function record_ezform() {
        Index2LoadTemplateEzform(ezf_id);
        $(".ezform-record").show();

    }
    function GetAllHospital(datas) {
        alert(datas);
        let data = [
                    {
                        "id": "10980",
                        "text": "โรงพยาบาลแก้งคร้อ"
                    },
                    {
                        "id": "00001",
                        "text": "สำนักงานสาธารณสุขจังหวัดสมุทรปราการ"
                    },
                    {
                        "id": "00002",
                        "text": "สำนักงานสาธารณสุขจังหวัดนนทบุรี"
                    }
                ];
        var fs = require("fs");
        let fileName = __dirname+"./assets/ezfile/hospital.json";
        fs.writeFile(fileName, JSON.stringify(data), function(err) {
            if(err) {
                return console.log(err);
            }

            console.log("The file was saved!");
        }); 
        // let selects =$("#"+selects).val(); knex('users').where('columnName', 'like', '%rowlikeme%')
        //'select * from users where id in (?)', [[1, 2, 3]]
        // let url = __dirname + "./assets/ezfile/all_hospital_thai.json";
        // $.ajax({
        //     url: url,
        //     dataType: 'json',
        //     success: function (data) {
        //         console.log(data);
        //     }
        // })
        // knexRemote.getHospital(hcodes).subscribe((res3) => {
        //     $("#"+selects).append(`
        //       <option value='${res3.hcode}'>${res3.name}</option>
        //     `);
        // });
        // let wheres = "";
        // knexRemote.knexfindById("all_hospital_thai", {hcode:hcodes}).subscribe((res3) => {
        //     

        // }, err => console.log(err));
    }
    function UpdateForm(ezf_id, table, id) {
        record_ezform();
        $("#updateID").val(id);
        $("#updateTABLE").val(table);





        knexRemote.knexfindById(table, { id: id }).subscribe(
            (row) => {

                knexRemote.knexfindById("ezform_fields", { ezf_id: ezf_id }).subscribe((res) => {
                    var arr = [];
                    for (var key in row) {
                        if (row.hasOwnProperty(key)) {
                            arr[key] = row[key]
                        }
                    };
                    // console.log(res);
                    if (res.ezf_field_type == 1 || res.ezf_field_type == 3 || res.ezf_field_type == 12 || res.ezf_field_type == 7 || res.ezf_field_type == 8 || res.ezf_field_type == 9) {
                        if (res.ezf_field_type == 3) {
                            $('.field-sddynamicmodel-' + res.ezf_field_name + ' .redactor-box .redactor-editor').append(arr[res.ezf_field_name]);
                        }
                        $("#sddynamicmodel-" + res.ezf_field_name).val(arr[res.ezf_field_name]);
                    }
                    if (res.ezf_field_type == 4 || res.ezf_field_type == 16) {//radio single checkbox
                        var radios = $("input[name='SDDynamicModel\\[" + res.ezf_field_name + "\\]']");//$("#sddynamicmodel-"+res2.ezf_field_name);
                        radios.filter('[value=' + arr[res.ezf_field_name] + ']').prop('checked', true);
                    }
                    if (res.ezf_field_type == 14) {
                        //file upload

                    }
                    if (res.ezf_field_type == 17) {
                        //all hospital list
                        var select2_hospitallist = {
                            "allowClear":true,
                            "minimumInputLength":3,
                            "ajax":{
                                "url":__dirname + "./assets/ezfile/hospital.json",
                                "dataType":"json",
                                quietMillis: 100,
                                "data":function(params) {
                                    
                                    GetAllHospital(params.term); 
                                    return {q:params.term}; 
                                },
                                beforeSend:function(data){
                                    console.log(data);
                                },
                                success:function(data){
                                    console.log(data);
                                },
                                processResults: function (data) {
                                    return {
                                        results: $.map(data, function (item) {
                                            return {
                                                text: item.text,
                                                id: item.id
                                            }
                                        })
                                    };
                                }
                                
                            },
                            "escapeMarkup":function (markup) { 
                                //console.log(markup);
                                return markup; 
                            },
                            "templateResult":function(result) { 
                                //console.log(result);
                                return result.text; 
                            },
                            "templateSelection":function (result) { 
                                //console.log(result);    
                                 return result.text; 
                            },
                            "theme":"krajee",
                            "width":"100%",
                            "placeholder":"Search for hospital ...",
                            "language":"en-US"
                        };
                        
                        //$('.field-sddynamicmodel-' + res.ezf_field_name).html('');
                        knexRemote.knexfindById("ezform_fields", { ezf_field_id: res.ezf_field_id }).subscribe(
                            (res2) => {
                                // let html = `
                                //             <div class="form-group field-sddynamicmodel-var14">
                                //                 <label class="control-label" for="sddynamicmodel-var14">Hospital list</label>
                                //                 <select id="sddynamicmodel-${res2.ezf_field_name}" class="form-control" name="SDDynamicModel[var14]">
                                //                    <option value='1'>sfs</option>
                                //                    <option value='1'>sfs</option>
                                //                    <option value='1'>sfs</option>
                                //                 </select>
                                //                 <p class="help-block help-block-error"></p>
                                //             </div> 
                                //         `;
                                // $('.field-sddynamicmodel-' + res.ezf_field_name).html(html);
                                //add select option
 
                                jQuery.when(jQuery('#sddynamicmodel-'+ res2.ezf_field_name)
                                .select2(select2_hospitallist))
                                .done(initS2Loading('sddynamicmodel-'+ res2.ezf_field_name, 's2options_d6851687'));

                                // // jQuery('#sddynamicmodel-'+ res2.ezf_field_name).on('change', function() { console.log('change = '+$(this).val()); });
                                // $('#sddynamicmodel-' + res2.ezf_field_name).select2({
                                //     //add select2
                                //    placeholder: res2.ezf_field_label,
                                //    theme:"bootstrap"
                                     
                                // }); 


                                $(document).on('keyup', ".select2-search__field", function () {
                                    let hcodes = $(this).val().toString();
                                    if (hcodes.length >= 4) {
                                        let selects1 = "sddynamicmodel-" + res2.ezf_field_name;
                                        //GetAllHospital(selects1, hcodes);
                                    }


                                });
                            },
                            (err) => console.log(err)
                        );
                        //$('.field-sddynamicmodel-var14').html('');
                    }
                    if (res.ezf_field_type == 19) {//checkbox multi

                        knexRemote.knexfindById("ezform_fields", { ezf_field_sub_id: res.ezf_field_id }).subscribe(
                            (res2) => {
                                var checkbox = $("input[name='SDDynamicModel\\[" + res2.ezf_field_name + "\\]']");
                                checkbox.filter('[value=' + arr[res2.ezf_field_name] + ']').prop('checked', true);

                            },
                            (err) => console.log(err)
                        );
                    }
                    if (res.ezf_field_type == 6)//dropdown
                    {
                        var theValue = $('#sddynamicmodel-' + res.ezf_field_name).val();
                        $('option[value=' + arr[res.ezf_field_name] + ']').attr('selected', true);
                    }


                    if (res.ezf_field_type == 23) {//scale
                        knexRemote.knexfindById("ezform_fields", { ezf_field_sub_id: res.ezf_field_id }).subscribe(
                            (res2) => {
                                //$("input[name='SDDynamicModel\\[var6r1\\]']").addClass('xxxxx');
                                var radios = $("input[name='SDDynamicModel\\[" + res2.ezf_field_name + "\\]']");//$("#sddynamicmodel-"+res2.ezf_field_name);
                                radios.filter('[value=' + arr[res2.ezf_field_name] + ']').prop('checked', true);

                            },
                            (err) => console.log(err)
                        );
                    }
                    if (res.ezf_field_type == 25) {//Grid
                        console.log("Grid");
                        //ezf_field_sub_id
                        knexRemote.knexfindById("ezform_fields", { ezf_field_sub_id: res.ezf_field_id }).subscribe(
                            (res2) => {
                                //console.log(res2.ezf_field_id);
                                knexRemote.knexfindById("ezform_fields", { ezf_field_sub_id: res2.ezf_field_id }).subscribe(
                                    (res3) => {
                                        if (res3.ezf_field_type == "251" || res3.ezf_field_type == "252" || res3.ezf_field_type == "253") {
                                            //text date textarea
                                            $("#sddynamicmodel-" + res3.ezf_field_name).val(arr[res3.ezf_field_name]);
                                        }
                                        if (res3.ezf_field_type == "254") {//checkbox
                                            var checkbox = $("input[name='SDDynamicModel\\[" + res3.ezf_field_name + "\\]']");
                                            checkbox.filter('[value=' + arr[res3.ezf_field_name] + ']').prop('checked', true);
                                        }


                                    },
                                    (err) => console.log(err)
                                );
                            },
                            (err) => console.log(err)
                        );
                    }//grid

                    if (res.ezf_field_type == 26) {
                        //Google Maps
                        console.log("Google Maps");
                        let var_google_map = res.ezf_field_name;
                        console.log(var_google_map);
                        knexRemote.knexfindById("ezform_fields", { ezf_field_sub_id: res.ezf_field_id }).subscribe((res2) => {
                            console.log(res2.ezf_field_name);
                        });

                    }



                });

            },
            (err) => { console.log(err) }
        );


    }
    function myID() {
        var n = Date.now();
        let val = n * 1000;
        return n + giveValues();
    }
    function giveValues() {
        var number = Math.round((Math.random() * 999999999));
        return number.toString().substr(0, 4);
    }

</script>

<style>
    input[type="radio"] {
        cursor: pointer;
        /* -webkit-appearance: none; */
        appearance: none;
        background: #34495E;
        border-radius: 1px;
        box-sizing: border-box;
        position: relative;
        box-sizing: content-box;
        width: 16px;
        height: 20px;
        border-width: 0;
        transition: all 0.3s linear;
        margin-right: 10px;
        position: relative;
        top: 5px;
    }

    input[type="checkbox"] {
        cursor: pointer;
        /* -webkit-appearance: none; */
        appearance: none;
        background: #34495E;
        border-radius: 1px;
        box-sizing: border-box;
        position: relative;
        box-sizing: content-box;
        width: 16px;
        height: 20px;
        border-width: 0;
        transition: all 0.3s linear;
        margin-right: 10px;
        position: relative;
        top: -4px;
        /* right: 5px; */
        /* margin-right: 10px; */
    }
</style>
